<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Registration</title>
</head>
<body>
    <h1>Register User</h1>
    <form action="/users" method="POST">
        <label for="username">Username:</label><br>
        <input type="text" name="username" id="username" required><br><br>

        <label for="password">Password:</label><br>
        <input type="password" name="password" id="password" required><br><br>

        <!-- Hidden CSRF token field -->
        <input type="hidden" name="_csrf" value="">

        <button type="submit">Register</button>
    </form>

    <h1>Login</h1>
    <form action="/login" method="POST">
        <label for="username">Username:</label><br>
        <input type="text" name="username" id="username" required><br><br>

        <label for="password">Password:</label><br>
        <input type="password" name="password" id="password" required><br><br>

        <!-- Hidden CSRF token field -->
        <input type="hidden" name="_csrf" value="">

        <button type="submit">Login</button>
    </form>

    <h1>Access Protected Data</h1>
    <button id="access-protected">Get Protected Data</button>

    <!-- axios dependency-->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // Function to get a cookie by name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Function to make an initial request to the backend
        function initializeSession() {
            fetch('http://localhost:3000/init-session', {
                method: 'GET',
                credentials: 'include' // Important to include credentials
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                // After the request, the cookies should be set
                const csrfToken = getCookie('XSRF-TOKEN');
                document.querySelector('input[name="_csrf"]').value = csrfToken;
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }

        // Initialize session oand set CSRF token on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeSession().then(() => {
                const csrfToken = getCookie('XSRF-TOKEN');
                document.querySelector('input[name="_csrf"]').value = csrfToken;
            });
        });

        document.getElementById('access-protected').addEventListener('click', () => {
            // get CSRF token
            const csrfToken = getCookie('XSRF-TOKEN');
            if (!csrfToken) {
            return res.status(403).send('CSRF token not found.');
            }
            // Make a GET request to the protected route
            axios.post('http://localhost:3000/protected', {
                method: 'GET',
                credentials: 'include', // Include cookies in the request
                _csrf: csrfToken // Include CSRF token in the body
            })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        // Unauthorized or forbidden
                        throw new Error('Unauthorized access');
                    } else {
                        throw new Error('Network response was not ok');
                    }
                }
                return response.json();
            })
            .then(data => {
                // Handle the protected data
                console.log('Protected data:', data);
                alert(`Message: ${data.message}\nUser: ${JSON.stringify(data.user)}`);
            })
            .catch(error => {
                console.error('Error accessing protected route:', error.message);
                alert('Error: ' + error.message);
                // Optionally, redirect to the login page
                // window.location.href = '/login.html';
            });
        });

    </script>
</body>
</html>
